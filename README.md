# Akamai Redirects with Hostname Buckets & Edge Redirector

This Terraform configuration deploys a scalable redirect solution on Akamai using **Hostname Buckets** and the **Edge Redirector Cloudlet**. It automates the entire lifecycle, including property creation, cloudlet policy management, and automatic DNS validation for Secure By Default (SBD) certificates.

## üöÄ Features

- **Dynamic Hostname Management**: Uses [Hostname Buckets](https://techdocs.akamai.com/property-mgr/docs/hostname-buckets) to add/remove hostnames without needing to activate a new property version.
- **Edge Redirector Integration**: Automatically generates Cloudlet policies mapping hostnames to their redirect targets.
- **Automated Certificate Validation**:
  - Extracts SBD (Secure By Default) DNS challenges.
  - Automatically creates the required `_acme-challenge` CNAME records in Akamai Edge DNS.
  - When activated on Akamai the production network the Domain Ownership should be automatically be validated.
- **Smart DNS Zone Handling**: Intelligently determines the correct DNS zone for records, supporting custom/delegated subzones.
- **Flexible Akamai Network selection**: Supports both Standard TLS (`edgesuite.net`) and Enhanced TLS (`edgekey.net`) based on configuration.
- **Conditional CP Code**: Uses an existing CP code or creates a new one if provided. If none provided it falls back to the default CP code behavior.

## üõ† Prerequisites

- **Terraform** >= 1.0
- **Akamai Credentials** (`.edgerc`) with permissions for:
  - Property Manager (PAPI)
  - Edge DNS (for challenge record creation)
  - Cloudlets
- **Akamai Terraform Provider** >= 9.2.0
- **Hostname Buckets** hostname bucket option should be enabled on the contract
- **Edge Redirector Cloudlet** The Edge Redirector cloudlet should be active on the contract

## üì¶ Configuration

### Key Variables

| Variable             | Description                                                                                                       | Default                     |
| :------------------- | :---------------------------------------------------------------------------------------------------------------- | :-------------------------- |
| `hostname_redirects` | **Core Variable**. A map where keys are hostnames and values are the target redirect URLs.                        | (Example map provided)      |
| `property_name`      | Name of the Akamai Property to create.                                                                            | `redirects.example.com`     |
| `domain_suffix`      | Determines security level. Use `edgekey.net` for ESSL (HTTPS) or `edgesuite.net` for Standard.                    | `edgesuite.net`             |
| `cpcode`             | Optional. ID of an existing CP code. If empty, uses default CP code.                                              | `""`                        |
| `custom_zones`       | List of DNS zones that are delegated/separate from the main domain. Helps the DNS logic find the right zone file. | `["subzone01.example.com"]` |
| `email_list`         | List of emails for activation notifications.                                                                      | `["test@example.nl"]`       |

### Example `terraform.tfvars`

```hcl
property_name = "my-redirect-service"
domain_suffix = "edgekey.net" # Use ESSL network

# Map hostnames to their destinations
hostname_redirects = {
  "shop.example.com" = "https://www.example.com/shop"
  "blog.example.com" = "https://medium.com/myblog"
  "old.example.com"  = "https://new.example.com"
}

# Handle DNS correctly for delegated subdomains
custom_zones = ["shop.example.com"]
```

## üèó Architecture

1.  **Cloudlet Policy**: Terraform creates an Edge Redirector policy. It iterates over `var.hostname_redirects` to create match rules.
    - **Regex Matching**: Uses a regex match (`https?://hostname`) to capture both HTTP and HTTPS traffic for each hostname.
    - **Deterministic Ordering**: The rules are explicitly sorted alphabetically by hostname. This ensures the policy structure remains stable and prevents unnecessary updates caused by map ordering differences.
2.  **Property**: Creates an Akamai Property configured to use Hostname Buckets and the Cloudlet Policy.
3.  **Hostname Bucket**: Populates the bucket with keys from `var.hostname_redirects`.
4.  **DNS Automation**:
    - Terraform reads the certificate challenges generated by the Hostname Bucket.
    - It calculates the correct DNS zone for each hostname (handling `var.custom_zones`).
    - It creates `akamai_dns_record` resources to satisfy the Let's Encrypt/SBD challenges.
    - It triggers `akamai_property_domainownership_validation` to complete the cert issuance.

## üìù Usage

1.  **Initialize**:

    ```bash
    terraform init
    ```

2.  **Plan**:

    ```bash
    terraform plan
    ```

    _Check the plan to ensure DNS records and Redirect rules look correct._

3.  **Apply**:
    ```bash
    terraform apply
    ```

## ‚ö†Ô∏è Important Notes

- **DNS Zone Must Exist**: The DNS zones for your hostnames must already exist in Akamai EdgeDNS before running Terraform. The `dns.tf` configuration creates `_acme-challenge` CNAME records for SBD certificate validation, but it cannot create the zone itself. If the zone doesn't exist, the `akamai_dns_record` resource will fail. Use `custom_zones` variable to specify any delegated subzones.
- **Automatic Dual-Network Activation**: This configuration automatically activates on **both Staging and Production** networks. Unlike typical Akamai workflows where you test on staging first, this redirect-only property is designed for rapid deployment. Since redirects are simple and low-risk, the staging-then-production workflow adds unnecessary delay. If you prefer to activate staging first, modify the `for_each` in the `akamai_property_activation` and `akamai_property_hostname_bucket` resources to only include `["STAGING"]`.
- **Provider Aliases**: This config uses a provider alias `akamai.edgedns` for DNS operations. Ensure your `.edgerc` has a `[dns]` section or configure the provider block in `provider.tf` accordingly.
- **Certificate Activation**: The first run creates the property and bucket. Certificate validation happens automatically via the DNS records created.
- **Hostname Buckets**: This feature allows for faster updates. Adding a new hostname to `var.hostname_redirects` updates the bucket and DNS records without necessarily requiring a full property activation (though Terraform may trigger one if the Cloudlet policy changes).
